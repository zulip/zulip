.widget-content {
    margin-bottom: var(--markdown-interelement-space-px);
}

.widget-choices {
    & ul {
        padding: 3px;
    }

    & li {
        padding: 2px;
        list-style: none;
    }

    & button {
        font-weight: 700;
        color: hsl(240deg 100% 50%);
    }

    .widget-choices-heading {
        font-weight: 600;
    }
}

.todo-widget {
    .todo-task-list-title-bar {
        flex: 1 1 auto;
        display: flex;
        /* Ensure controls remain visible on narrower screens. */
        flex-flow: row wrap;
        gap: 5px;
        margin-bottom: var(--markdown-interelement-space-px);
    }

    .add-task-bar {
        display: flex;
        /* Ensure controls remain visible on narrower screens. */
        flex-flow: row wrap;
        gap: 5px;
    }

    /* For the box-shadow to be visible on the left */
    .add-task,
    .add-desc {
        font-weight: 400;
    }

    & label.checkbox {
        display: flex; /* Arrange that a multi-line description line wraps properly. */
        /* Keep checkboxes vertically aligned, including with multi-line tasks. */
        align-items: baseline;
        /* Reset default label.checkbox styles. */
        gap: 5px;
        position: static;
        min-height: 0;

        & input[type="checkbox"] {
            ~ .custom-checkbox {
                display: inline-block;
                vertical-align: middle;
                position: static;

                padding: 2px;
                margin: 0;

                font-size: 1.3em; /* 18.2px / 14px em */
                height: 0.6593em; /* 12px at 18.2px / em */
                width: 0.6593em; /* 12px at 18.2px / em */

                font-weight: 300;
                line-height: 0.8;
                text-align: center;
                border: 2px solid var(--color-border-todo-checkbox);

                border-radius: 4px;
                filter: brightness(1);

                cursor: pointer;
            }

            &:checked ~ .custom-checkbox {
                background-image: url("../images/checkbox-white.svg");
                background-size: 75%;
                background-position: 50% 50%;
                background-repeat: no-repeat;
                background-color: var(--color-background-todo-checkbox-checked);
                border-color: var(--color-border-todo-checkbox-checked);
            }

            &:disabled ~ .custom-checkbox {
                opacity: 0.5;
                cursor: not-allowed;
            }

            &:hover ~ .custom-checkbox {
                border-color: var(--color-border-todo-checkbox-hover);
            }

            &:not(:checked):hover ~ .custom-checkbox {
                /* We only change the background color on hover,
                   when the checkbox is not checked. */
                background-color: var(--color-background-todo-checkbox-hover);
            }

            &:focus ~ .custom-checkbox {
                outline-color: hsl(0deg 0% 100% / 0%);
            }
        }
    }
}

.todo-widget,
.poll-widget {
    .poll-question-header,
    .todo-task-list-title-header {
        font-size: 1.1em;
        font-weight: 600;
    }

    & li {
        display: flex;
        gap: 5px;
        align-items: baseline;
        list-style: none;
        margin: 0 0 5px;
    }

    & ul {
        margin: 0 0 5px;
        padding: 0;
    }

    & input[type="text"] {
        /* Reset from zulip.css */
        height: unset;
        border: 1px solid hsl(0deg 0% 80%);
        box-shadow: inset 0 1px 1px hsl(0deg 0% 0% / 7.5%);
        border-radius: 4px;
        color: var(--color-text-default);

        &:focus {
            border-color: hsl(206deg 80% 62% / 80%);
            outline: 0;
            box-shadow: none;
            background-color: var(--color-background-widget-input);
            transition:
                border-color linear 0.2s,
                box-shadow linear 0.2s;
        }
    }
}

.poll-widget {
    .poll-option-bar {
        display: flex;
        /* Ensure controls remain visible on narrower screens. */
        flex-flow: row wrap;
        gap: 5px;
    }

    .poll-option {
        font-weight: 400;
    }

    .poll-option-label {
        display: flex;
        gap: 5px;
        align-items: baseline;
    }

    .poll-option-text {
        font-weight: 600;
        /* Start with max-content, but allow options
           to shrink, so that voting names wrap comfortably. */
        flex: 0 1 max-content;
    }

    .poll-vote {
        color: var(--color-poll-vote);
        border-color: var(--color-border-poll-vote);
        border-style: solid;
        font-weight: 600;
        border-radius: 3px;
        /* We don't want poll-vote tallies to spill
           digits onto second lines in narrow viewports. */
        flex-shrink: 0;
        min-width: 1.7857em; /* 25px at 14px / em */
        height: 1.7857em; /* 25px at 14px / em */
        font-size: 0.9285em; /* 13px at 14px / em */
        background-color: var(--color-background-widget-button);

        &:hover {
            color: var(--color-poll-vote-hover);
            background-color: var(--color-background-poll-vote-hover);
            border-color: var(--color-border-poll-vote-hover);
        }

        &:focus {
            outline: 0;
            color: var(--color-poll-vote-focus);
            background-color: var(--color-background-poll-vote-focus);
            border-color: var(--color-border-poll-vote-focus);
        }

        &:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    }

    .poll-names {
        color: var(--color-poll-names);
        /* Aim for 50% of the flexbox for voting names,
           but also shrink modestly (.5) adjacent a long
           option. */
        flex: 1 0.5 50%;
    }
}

button {
    &.task {
        height: 20px;
        width: 20px;
        background-color: transparent;
        border-color: hsl(156deg 28% 70%);
        margin-right: 4px;
        border-radius: 3px;

        &:hover {
            border: 1px solid hsl(194deg 60% 40%);
        }
    }

    &.add-task,
    &.poll-option {
        color: hsl(156deg 41% 40%);
        border: 1px solid hsl(156deg 28% 70%);
        width: max-content;
        flex: 0 0 auto;
        border-radius: 3px;
        background-color: var(--color-background-widget-button);
        padding: 4px;
        padding-left: 14px;
        padding-right: 14px;

        &:hover,
        &:focus {
            outline: 0;
            border-color: hsl(156deg 30% 50%);
            transition: 0.2s ease;
            transition-property: background-color, border-color, color;
        }

        &:active {
            transition: 0.2s ease;
            transition-property: background-color, border-color, color;
        }

        &:disabled {
            cursor: not-allowed;
            filter: saturate(0);
            background-color: var(--color-background-zulip-button-disabled);
            color: hsl(0deg 3% 52%);
        }
    }
}

input {
    &.add-task,
    &.add-desc,
    &.poll-option,
    &.poll-question,
    &.todo-task-list-title {
        flex: 1 0 auto;
        padding: var(--input-vertical-padding) var(--input-horizontal-padding);
    }
}

.widget-error {
    color: hsl(1deg 45% 50%);
    font-size: 0.8571em; /* 12px at 14px/em */
    display: flex;
    align-items: center;
}

.poll-question-check,
.poll-question-remove,
.todo-task-list-title-check,
.todo-task-list-title-remove {
    align-self: stretch;
    /* TODO: Re-express the 30.5px value here
       as part of information density work. */
    flex: 0 0 30.5px;
    min-height: 30.5px;
    border-radius: 3px;
    border: 1px solid var(--color-border-zulip-button);
    background-color: var(--color-background-zulip-button);

    &:hover {
        border-color: var(--color-border-zulip-button-interactive);
        background-color: var(--color-background-zulip-button-hover);
    }
}

.poll-edit-question,
.todo-edit-task-list-title {
    color: var(--color-message-action-visible);

    &:hover,
    &:focus-visible {
        color: var(--color-message-action-interactive);
    }
}

.poll-question-bar {
    flex: 1 1 auto;
    display: flex;
    /* Ensure controls remain visible on narrower screens. */
    flex-flow: row wrap;
    gap: 5px;
    /* Reserve space for the focus outline to prevent it from being cut off */
    margin-right: 2px;
    margin-bottom: var(--markdown-interelement-space-px);
}

.poll-widget-header-area,
.todo-widget-header-area {
    display: flex;
    align-items: baseline;
    gap: 5px;
}

.current-user-vote {
    background-color: hsl(156deg 10% 90% / 90%);
}

.add-task-wrapper {
    display: inline;
    position: relative;
    z-index: 1;

    /* Unlike other browsers like Chrome, Microsoft Edge, etc.,
    Firefox does not automatically display the "not-allowed"
    cursor for disabled elements. The below css ensures that the
    correct cursor is shown across all browsers. */
    &:hover {
        cursor: not-allowed;
    }
}

/* Rich Embed Widget - Discord-style embeds */
.widget-rich-embed {
    background-color: var(--color-background-widget-input, hsl(0deg 0% 97%));
    border-left: 4px solid hsl(227deg 58% 65%);
    border-radius: 4px;
    padding: 12px 16px;
    max-width: 520px;
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 8px;

    .embed-author {
        grid-column: 1 / -1;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.875em;
    }

    .embed-author-icon {
        width: 24px;
        height: 24px;
        border-radius: 50%;
    }

    .embed-author-name {
        font-weight: 600;
        color: var(--color-text-default);
    }

    a.embed-author-name {
        text-decoration: none;

        &:hover {
            text-decoration: underline;
        }
    }

    .embed-title {
        font-weight: 600;
        font-size: 1em;
        color: var(--color-text-default);

        & a {
            color: hsl(200deg 100% 50%);
            text-decoration: none;

            &:hover {
                text-decoration: underline;
            }
        }
    }

    .embed-description {
        font-size: 0.9375em;
        color: var(--color-text-default);
        white-space: pre-wrap;
    }

    .embed-fields {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .embed-field {
        flex: 1 0 100%;
        min-width: 0;

        &.embed-field-inline {
            flex: 1 0 calc(33% - 8px);
        }
    }

    .embed-field-name {
        font-weight: 600;
        font-size: 0.875em;
        margin-bottom: 2px;
    }

    .embed-field-value {
        font-size: 0.875em;
    }

    .embed-image {
        grid-column: 1 / -1;

        & img {
            max-width: 100%;
            border-radius: 4px;
        }
    }

    .embed-thumbnail {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 4px;
        grid-row: 1 / span 3;
        grid-column: 2;
    }

    .embed-footer {
        grid-column: 1 / -1;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.75em;
        color: var(--color-text-default);
        opacity: 0.8;
    }

    .embed-footer-icon {
        width: 20px;
        height: 20px;
        border-radius: 50%;
    }
}

/* Interactive Widget - Buttons and Select Menus */
.widget-interactive {
    .widget-content-text {
        margin-bottom: 8px;
    }

    .widget-action-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 8px;

        &:last-child {
            margin-bottom: 0;
        }
    }

    .widget-button {
        padding: 8px 16px;
        border-radius: 4px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.15s, border-color 0.15s, opacity 0.15s;
        position: relative;

        &:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    }

    /* Pending state for buttons - shown while waiting for bot response */
    .widget-button-pending {
        opacity: 0.7;
        pointer-events: none;

        /* Spinner overlay */
        &::after {
            content: "";
            position: absolute;
            top: 50%;
            right: 8px;
            width: 14px;
            height: 14px;
            margin-top: -7px;
            border: 2px solid currentcolor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: widget-button-spin 0.8s linear infinite;
        }
    }

    @keyframes widget-button-spin {
        to {
            transform: rotate(360deg);
        }
    }

    .widget-button-primary {
        background-color: hsl(235deg 86% 65%);
        border: 1px solid hsl(235deg 86% 65%);
        color: white;

        &:hover:not(:disabled) {
            background-color: hsl(235deg 86% 55%);
        }
    }

    .widget-button-secondary {
        background-color: hsl(214deg 10% 40%);
        border: 1px solid hsl(214deg 10% 40%);
        color: white;

        &:hover:not(:disabled) {
            background-color: hsl(214deg 10% 30%);
        }
    }

    .widget-button-success {
        background-color: hsl(139deg 47% 44%);
        border: 1px solid hsl(139deg 47% 44%);
        color: white;

        &:hover:not(:disabled) {
            background-color: hsl(139deg 47% 34%);
        }
    }

    .widget-button-danger {
        background-color: hsl(359deg 67% 54%);
        border: 1px solid hsl(359deg 67% 54%);
        color: white;

        &:hover:not(:disabled) {
            background-color: hsl(359deg 67% 44%);
        }
    }

    .widget-button-link {
        background-color: transparent;
        border: none;
        color: hsl(200deg 100% 50%);
        padding: 8px 4px;

        &:hover:not(:disabled) {
            text-decoration: underline;
        }
    }

    .widget-select {
        padding: 8px 12px;
        border-radius: 4px;
        border: 1px solid hsl(0deg 0% 80%);
        background-color: var(--color-background-widget-input, white);
        min-width: 150px;
        cursor: pointer;

        &:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    }
}

/* Freeform Widget - Custom HTML/JS/CSS */
.widget-freeform {
    /* Container for freeform widgets - minimal styling to not interfere */
    position: relative;
}

/* Bot Modal Form */
.bot-modal-form {
    .bot-modal-action-row {
        margin-bottom: 16px;

        &:last-child {
            margin-bottom: 0;
        }
    }

    .bot-modal-text-input-container {
        margin-bottom: 12px;

        &:last-child {
            margin-bottom: 0;
        }

        & label {
            display: block;
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 0.9em;
        }

        & input[type="text"],
        & textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid hsl(0deg 0% 80%);
            border-radius: 4px;
            background-color: var(--color-background-widget-input, white);
            font-family: inherit;
            font-size: 1em;

            &:focus {
                border-color: hsl(206deg 80% 62%);
                outline: none;
                box-shadow: 0 0 0 2px hsl(206deg 80% 62% / 20%);
            }

            &::placeholder {
                color: hsl(0deg 0% 60%);
            }
        }

        & textarea {
            min-height: 100px;
            resize: vertical;
        }
    }
}

/* Command Invocation Widget - Discord-style slash command display */
.widget-command-invocation {
    display: inline-flex;
    flex-direction: column;
    background-color: var(--color-background-widget-input, hsl(225deg 25% 97%));
    border-radius: 4px;
    padding: 8px 12px;
    font-size: 0.95em;

    &.command-pending {
        opacity: 0.7;
    }

    .command-header {
        display: flex;
        align-items: center;
        gap: 4px;
        flex-wrap: wrap;
    }

    .command-label {
        color: var(--color-text-default);
        opacity: 0.7;
    }

    .command-name {
        color: hsl(235deg 86% 65%);
        font-weight: 600;
        background-color: hsl(235deg 86% 65% / 10%);
        padding: 2px 6px;
        border-radius: 3px;
    }

    .command-with {
        color: var(--color-text-default);
        opacity: 0.7;
    }

    .command-bot-avatar {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin-left: 2px;
    }

    .command-bot-name {
        font-weight: 500;
        color: var(--color-text-default);
    }

    .command-arguments {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 6px;
        padding-top: 6px;
        border-top: 1px solid hsl(0deg 0% 0% / 8%);
    }

    .command-argument {
        display: flex;
        align-items: center;
        gap: 4px;
        background-color: hsl(0deg 0% 0% / 5%);
        padding: 2px 8px;
        border-radius: 3px;
    }

    .argument-name {
        color: var(--color-text-default);
        opacity: 0.7;
        font-size: 0.9em;

        &::after {
            content: ":";
        }
    }

    .argument-value {
        font-weight: 500;
        color: var(--color-text-default);
    }

    /* Responding indicator - three animated dots */
    .command-responding-indicator {
        display: inline-flex;
        align-items: center;
        gap: 3px;
        margin-left: 8px;
    }

    .responding-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background-color: var(--color-text-default);
        opacity: 0.4;
        animation: responding-pulse 1.4s infinite ease-in-out;

        &:nth-child(1) {
            animation-delay: 0s;
        }

        &:nth-child(2) {
            animation-delay: 0.2s;
        }

        &:nth-child(3) {
            animation-delay: 0.4s;
        }
    }

    @keyframes responding-pulse {
        0%,
        80%,
        100% {
            opacity: 0.4;
            transform: scale(1);
        }

        40% {
            opacity: 1;
            transform: scale(1.2);
        }
    }

    /* Error state */
    &.command-error {
        border-left: 3px solid hsl(0deg 70% 50%);
    }

    .command-error-indicator {
        margin-left: 8px;
        color: hsl(0deg 70% 50%);
    }

    .command-error-message {
        margin-top: 6px;
        padding: 4px 8px;
        font-size: 0.85em;
        color: hsl(0deg 70% 40%);
        background-color: hsl(0deg 70% 95%);
        border-radius: 3px;
    }
}

/* Ephemeral/private response styling */
.messagebox-content > .ephemeral-response-container {
    /* Place in the ephemeral grid area, spanning the message column */
    grid-area: ephemeral;
    /* Explicit row/column as fallback if grid-area doesn't work */
    grid-row: 6;
    grid-column: 2;
    margin-top: 8px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    /* Ensure proper width - don't let it collapse */
    min-width: 0;
}

.ephemeral-response {
    position: relative;
    background-color: var(--color-background-private-message-content);
    border-left: 3px solid hsl(45deg 70% 50%);
    border-radius: 4px;
    padding: 8px 12px;
    animation: ephemeral-fade-in 0.3s ease-out;
}

@keyframes ephemeral-fade-in {
    from {
        opacity: 0;
        transform: translateY(-4px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.ephemeral-header {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 6px;
    font-size: 0.85em;
    color: var(--color-text-default);
    opacity: 0.7;
}

.ephemeral-icon {
    display: flex;
    align-items: center;
    justify-content: center;
}

.ephemeral-icon i {
    font-size: 14px;
    color: hsl(45deg 70% 50%);
}

.ephemeral-visibility {
    flex: 1;
    font-style: italic;
}

.ephemeral-dismiss {
    background: none;
    border: none;
    padding: 2px 4px;
    cursor: pointer;
    color: var(--color-text-default);
    opacity: 0.5;
    border-radius: 3px;
    transition: opacity 0.15s ease;

    &:hover {
        opacity: 1;
    }

    & i {
        font-size: 12px;
    }
}

.ephemeral-content {
    color: var(--color-text-default);

    /* Ensure markdown renders properly */
    & p:last-child {
        margin-bottom: 0;
    }
}
