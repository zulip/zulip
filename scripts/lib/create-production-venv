#!/usr/bin/env -S uv run --frozen --no-config --only-group=install --preview-features=target-workspace-discovery --script  # -*-python-*-
import argparse
import os
import platform
import shutil
import sys

from scripts.lib.setup_venv import get_venv_dependencies
from scripts.lib.zulip_tools import get_zulip_pwent, os_families, run, su_to_zulip

ZULIP_PATH = os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

parser = argparse.ArgumentParser(description="Create a production virtualenv with caching")
parser.add_argument("deploy_path")
args = parser.parse_args()

# install dependencies for setting up the virtualenv
distro_info = platform.freedesktop_os_release()
vendor = distro_info["ID"]
os_version = distro_info["VERSION_ID"]
VENV_DEPENDENCIES = get_venv_dependencies(vendor, os_version)
if "debian" in os_families():
    run(["apt-get", "-y", "install", "--no-install-recommends", *VENV_DEPENDENCIES])
elif "fedora" in os_families():
    run(["yum", "-y", "install", *VENV_DEPENDENCIES])
else:
    print("Unsupported platform: {}".format(distro_info["ID"]))
    sys.exit(1)

os.chdir(ZULIP_PATH)

pwent = get_zulip_pwent()
if os.stat(".venv").st_uid != pwent.pw_uid:
    print("Deleting .venv so it can be re-created as zulip")
    shutil.rmtree(".venv")
    os.mkdir(".venv")
    os.chown(".venv", pwent.pw_uid, pwent.pw_gid)


def uv_sync_preexec() -> None:
    su_to_zulip()
    os.environ.pop("PYTHONDEVMODE", None)
    os.environ.pop("PYTHONWARNINGS", None)


run(["uv", "sync", "--frozen", "--only-group=prod"], preexec_fn=uv_sync_preexec)
