{{! Client-side Mustache template for rendering messages.}}

{{#each message_groups}}
{{#with this}}

{{#if show_date}}
<div class="date_row">{{{show_date}}}</div>
{{/if}}

{{#if bookend_top}}
{{partial "bookend"}}
{{/if}}

<div class="recipient_row">
  {{#if is_stream}}
    <div class="message_header message_header_stream right_part">
      <div class="message-header-wrapper">
        <div class="message-header-contents">
          {{! stream link }}
          <a class="message_label_clickable narrows_by_recipient stream_label {{color_class}}"
             style="background: {{background_color}}; border-left-color: {{background_color}};"
             href="{{stream_url}}"
             title="Narrow to stream &quot;{{display_recipient}}&quot;">
             {{! invite only lock }}
             {{#if invite_only}}
               <i class="icon-vector-lock invite-stream-icon" title="This is an invite-only stream"></i>
             {{/if}}
               {{display_recipient}}
          </a>

          {{! hidden narrow icon for copy-pasting }}
          <span class="copy-paste-text">&gt;</span>

          {{! topic stuff }}
          <span class="stream_topic">
            {{! topic link }}
            <a class="message_label_clickable narrows_by_subject"
               href="{{topic_url}}"
               title="Narrow to stream &quot;{{display_recipient}}&quot;, topic &quot;{{subject}}&quot;">
              {{#if ../../../use_match_properties}}
                {{{match_subject}}}
              {{else}}
                {{subject}}
              {{/if}}
            </a>

            {{! edit subject pencil icon }}
            {{#if always_visible_topic_edit}}
              <i class="icon-vector-pencil always_visible_topic_edit"></i>
            {{else}}
              {{#if on_hover_topic_edit}}
              <i class="icon-vector-pencil on_hover_topic_edit"></i>
              {{/if}}
            {{/if}}

            {{! exterior links (e.g. to a trac ticket) }}
            {{#each subject_links}}
            <a href="{{this}}" target="_blank">
              <i class="icon-vector-external-link-sign"></i>
            </a>
            {{/each}}
          </span>

          <span class="topic_edit">
            <span class="topic_edit_form" id="{{id}}"></span>
          </span>
        </div>
      </div>
    </div>
  {{else}}
    <div class="message_header message_header_private_message dark_background">
      <div class="message-header-wrapper">
        <div class="message-header-contents">
          <a class="message_label_clickable narrows_by_recipient"
             href="{{pm_with_url}}"
             title="Narrow to your private messages with {{display_reply_to}}">
          You and {{display_reply_to}}
          </a>
        </div>
      </div>
    </div>
  {{/if}}
  {{#each messages}}
  {{#with this}}
    {{partial "single_message" "use_match_properties" ../../../../use_match_properties}}
  {{/with}}
  {{/each}}
</div>

{{#if bookend_bottom}}
{{partial "bookend"}}
{{/if}}

{{/with}}
{{/each}}
